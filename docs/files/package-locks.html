
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <title>npm-package-locks &#8212; npm-docs 6.9.1 文档</title>
    <link rel="stylesheet" href="../_static/sphinx13.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>

    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="npm-package.json" href="package.json.html" />
    <link rel="prev" title="npm-package-lock.json" href="package-lock.json.html" />
<link rel="canonical" href="http://www.sphinx-doc.org/en/master/files/package-locks.html" />

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet" type="text/css" />
 
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
  
</style>
<script type="text/javascript">
  // intelligent scrolling of the sidebar content
  $(window).scroll(function() {
    var sb = $('.sphinxsidebarwrapper');
    var win = $(window);
    var sbh = sb.height();
    var offset = $('.sphinxsidebar').position()['top'];
    var wintop = win.scrollTop();
    var winbot = wintop + win.innerHeight();
    var curtop = sb.position()['top'];
    var curbot = curtop + sbh;
    // does sidebar fit in window?
    if (sbh < win.innerHeight()) {
      // yes: easy case -- always keep at the top
      sb.css('top', $u.min([$u.max([0, wintop - offset - 10]), $(document).height() - sbh - 200]));
    } else {
      // no: only scroll if top/bottom edge of sidebar is at
      // top/bottom edge of window
      if (curtop > wintop && curbot > winbot) {
        sb.css('top', $u.max([wintop - offset - 10, 0]));
      } else if (curtop < wintop && curbot < winbot) {
        sb.css('top', $u.min([winbot - sbh - offset - 20, $(document).height() - sbh - 200]));
      }
    }
  });
</script> 
  </head><body>
<div class="pageheader">
  <ul>
    <li><a href="../index.html">主页</a></li>
    <li><a href="../about-npm.html">关于</a></li>
    <li><a href="../getting-started/index.html">入门</a></li>
    <li><a href="../packages-and-modules/index.html">包和模块</a></li>
    <li><a href="../cli/index.html">指令</a></li>
    <li><a href="../integrations/index.html">集成</a></li>
    <li><a href="../orgs/index.html">组织</a></li>
    <li><a href="../enterprise/index.html">企业版</a></li>
  </ul>
  <div>
    <a href="../index.html">
      <!-- <img src="../_static/wxaheader.png" alt="wxa" /> -->
      <svg viewBox="0 0 780 250">
        <path
          fill="#231F20"
          d="M240,250h100v-50h100V0H240V250z M340,50h50v100h-50V50z M480,0v200h100V50h50v150h50V50h50v150h50V0H480z M0,200h100V50h50v150h50V0H0V200z"
        ></path>
      </svg>
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="package.json.html" title="npm-package.json"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="package-lock.json.html" title="npm-package-lock.json"
             accesskey="P">上一页</a> |</li>
<li><a href="../index.html">主页</a>&#160;|</li>
<li><a href="../contents.html">文档</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">files</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">npm-package-locks</a><ul>
<li><a class="reference internal" href="#see-also">SEE ALSO</a></li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="package-lock.json.html"
                        title="上一章">npm-package-lock.json</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="package.json.html"
                        title="下一章">npm-package.json</a></p>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/files/package-locks.rst.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="npm-package-locks">
<span id="package-locks"></span><h1>npm-package-locks<a class="headerlink" href="#npm-package-locks" title="永久链接至标题">¶</a></h1>
<p>An explanation of npm lockfiles
DESCRIPTION
Conceptually, the “input” to npm-install is a package.json, while its “output” is a fully-formed node_modules tree: a representation of the dependencies you declared. In an ideal world, npm would work like a pure function: the same package.json should produce the exact same node_modules tree, any time. In some cases, this is indeed true. But in many others, npm is unable to do this. There are multiple reasons for this:</p>
<p>different versions of npm (or other package managers) may have been used to install a package, each using slightly different installation algorithms.</p>
<p>a new version of a direct semver-range package may have been published since the last time your packages were installed, and thus a newer version will be used.</p>
<p>A dependency of one of your dependencies may have published a new version, which will update even if you used pinned dependency specifiers (1.2.3 instead of ^1.2.3)</p>
<p>The registry you installed from is no longer available, or allows mutation of versions (unlike the primary npm registry), and a different version of a package exists under the same version number now.</p>
<p>As an example, consider package A:</p>
<dl>
<dt>{</dt><dd><p>“name”: “A”,
“version”: “0.1.0”,
“dependencies”: {</p>
<blockquote>
<div><p>“B”: “&lt;0.1.0”</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}
package B:</p>
<dl>
<dt>{</dt><dd><p>“name”: “B”,
“version”: “0.0.1”,
“dependencies”: {</p>
<blockquote>
<div><p>“C”: “&lt;0.1.0”</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}
and package C:</p>
<dl class="simple">
<dt>{</dt><dd><p>“name”: “C”,
“version”: “0.0.1”</p>
</dd>
</dl>
<p>}
If these are the only versions of A, B, and C available in the registry,
then a normal npm install A will install:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>A@0.1.0
`-- B@0.0.1
    `-- C@0.0.1
</pre></div>
</div>
<p>However, if <a class="reference external" href="mailto:B&#37;&#52;&#48;0&#46;0&#46;2">B<span>&#64;</span>0<span>&#46;</span>0<span>&#46;</span>2</a> is published, then a fresh npm install A will install:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>A@0.1.0
`-- B@0.0.2
    `-- C@0.0.1
</pre></div>
</div>
<p>assuming the new version did not modify B’s dependencies. Of course, the new version of B could include a new version of C and any number of new dependencies. If such changes are undesirable, the author of A could specify a dependency on <a class="reference external" href="mailto:B&#37;&#52;&#48;0&#46;0&#46;1">B<span>&#64;</span>0<span>&#46;</span>0<span>&#46;</span>1</a>. However, if A’s author and B’s author are not the same person, there’s no way for A’s author to say that he or she does not want to pull in newly published versions of C when B hasn’t changed at all.</p>
<p>To prevent this potential issue, npm uses package-lock.json or, if present, npm-shrinkwrap.json. These files are called package locks, or lockfiles.</p>
<p>Whenever you run npm install, npm generates or updates your package lock, which will look something like this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span>{
  &quot;name&quot;: &quot;A&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  ...metadata fields...
  &quot;dependencies&quot;: {
    &quot;B&quot;: {
      &quot;version&quot;: &quot;0.0.1&quot;,
      &quot;resolved&quot;: &quot;https://registry.npmjs.org/B/-/B-0.0.1.tgz&quot;,
      &quot;integrity&quot;: &quot;sha512-DeAdb33F+&quot;
      &quot;dependencies&quot;: {
        &quot;C&quot;: {
          &quot;version&quot;: &quot;git://github.com/org/C.git#5c380ae319fc4efe9e7f2d9c78b0faa588fd99b4&quot;
        }
      }
    }
  }
}
</pre></div>
</div>
<p>This file describes an exact, and more importantly reproducible node_modules tree. Once it’s present, any future installation will base its work off this file, instead of recalculating dependency versions off package.json.</p>
<p>The presence of a package lock changes the installation behavior such that:</p>
<p>The module tree described by the package lock is reproduced. This means reproducing the structure described in the file, using the specific files referenced in “resolved” if available, falling back to normal package resolution using “version” if one isn’t.</p>
<p>The tree is walked and any missing dependencies are installed in the usual fashion.</p>
<p>If preshrinkwrap, shrinkwrap or postshrinkwrap are in the scripts property of the package.json, they will be executed in order. preshrinkwrap and shrinkwrap are executed before the shrinkwrap, postshrinkwrap is executed afterwards. These scripts run for both package-lock.json and npm-shrinkwrap.json. For example to run some postprocessing on the generated file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;scripts&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;postshrinkwrap&quot;</span><span class="p">:</span> <span class="s2">&quot;json -I -e </span><span class="se">\&quot;</span><span class="s2">this.myMetadata = $MY_APP_METADATA</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using locked packages</p>
<p>Using a locked package is no different than using any package without a package lock: any commands that update node_modules and/or package.json’s dependencies will automatically sync the existing lockfile. This includes npm install, npm rm, npm update, etc. To prevent this update from happening, you can use the –no-save option to prevent saving altogether, or –no-shrinkwrap to allow package.json to be updated while leaving package-lock.json or npm-shrinkwrap.json intact.</p>
<p>It is highly recommended you commit the generated package lock to source control: this will allow anyone else on your team, your deployments, your CI/continuous integration, and anyone else who runs npm install in your package source to get the exact same dependency tree that you were developing on. Additionally, the diffs from these changes are human-readable and will inform you of any changes npm has made to your node_modules, so you can notice if any transitive dependencies were updated, hoisted, etc.</p>
<p>Resolving lockfile conflicts
Occasionally, two separate npm install will create package locks that cause merge conflicts in source control systems. As of <a class="reference external" href="mailto:npm&#37;&#52;&#48;5&#46;7&#46;0">npm<span>&#64;</span>5<span>&#46;</span>7<span>&#46;</span>0</a>, these conflicts can be resolved by manually fixing any package.json conflicts, and then running npm install [–package-lock-only] again. npm will automatically resolve any conflicts for you and write a merged package lock that includes all the dependencies from both branches in a reasonable tree. If –package-lock-only is provided, it will do this without also modifying your local node_modules/.</p>
<p>To make this process seamless on git, consider installing npm-merge-driver, which will teach git how to do this itself without any user interaction. In short: $ npx npm-merge-driver install -g will let you do this, and even works with <a class="reference external" href="mailto:pre-npm&#37;&#52;&#48;5&#46;7&#46;0">pre-npm<span>&#64;</span>5<span>&#46;</span>7<span>&#46;</span>0</a> versions of npm 5, albeit a bit more noisily. Note that if package.json itself conflicts, you will have to resolve that by hand and run npm install manually, even with the merge driver.</p>
<div class="section" id="see-also">
<h2>SEE ALSO<a class="headerlink" href="#see-also" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://medium.com/&#64;sdboyer/so-you-want-to-write-a-package-manager-4ae9c17d9527">https://medium.com/&#64;sdboyer/so-you-want-to-write-a-package-manager-4ae9c17d9527</a></p></li>
<li><p><a class="reference internal" href="package.json.html#package-json"><span class="std std-ref">npm-package.json</span></a></p></li>
<li><p><code class="xref std std-option docutils literal notranslate"><span class="pre">package-lock.json</span></code></p></li>
<li><p><code class="xref std std-option docutils literal notranslate"><span class="pre">npm</span> <span class="pre">shrinkwrap.json</span></code></p></li>
<li><p><a class="reference internal" href="../cli/shrinkwrap.html#cmdoption-npm-arg-shrinkwrap"><code class="xref std std-option docutils literal notranslate"><span class="pre">npm</span> <span class="pre">shrinkwrap</span></code></a></p></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="package.json.html" title="npm-package.json"
             >下一页</a> |</li>
        <li class="right" >
          <a href="package-lock.json.html" title="npm-package-lock.json"
             >上一页</a> |</li>
<li><a href="../index.html">主页</a>&#160;|</li>
<li><a href="../contents.html">文档</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >files</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; 版权所有 2019, BandCap.
      由 <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.0+/8aaa12d 创建。
    </div>
  </body>
</html>